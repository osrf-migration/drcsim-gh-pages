{"priority": "major", "kind": "bug", "repository": {"links": {"self": {"href": "data/repositories/osrf/drcsim.json"}, "html": {"href": "#!/osrf/drcsim"}, "avatar": {"href": "data/bytebucket.org/ravatar/{247b5408-ae91-4e3c-b2f9-a21994658d11}ts=c_plus_plus"}}, "type": "repository", "name": "drcsim", "full_name": "osrf/drcsim", "uuid": "{247b5408-ae91-4e3c-b2f9-a21994658d11}"}, "links": {"attachments": {"href": "data/repositories/osrf/drcsim/issues/282/attachments_page=1.json"}, "self": {"href": "data/repositories/osrf/drcsim/issues/282.json"}, "watch": {"href": "https://api.bitbucket.org/2.0/repositories/osrf/drcsim/issues/282/watch"}, "comments": {"href": "data/repositories/osrf/drcsim/issues/282/comments_page=1.json"}, "html": {"href": "#!/osrf/drcsim/issues/282/more-more-firehose-issues-roterr-error"}, "vote": {"href": "https://api.bitbucket.org/2.0/repositories/osrf/drcsim/issues/282/vote"}}, "reporter": {"display_name": "Chris Atkeson", "uuid": "{3bdaa162-b747-4fa9-9d6e-a2d5c92933c6}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7B3bdaa162-b747-4fa9-9d6e-a2d5c92933c6%7D"}, "html": {"href": "https://bitbucket.org/%7B3bdaa162-b747-4fa9-9d6e-a2d5c92933c6%7D/"}, "avatar": {"href": "https://bitbucket.org/account/catkeson/avatar/"}}, "nickname": "catkeson", "type": "user", "account_id": null}, "title": "more more firehose issues: rotErr Error", "component": null, "votes": 0, "watches": 4, "content": {"raw": "I believe the rotation error calculation in the firehose alignment does not currently make sense. I printed out a bunch of stuff at the beginning of VRC_TASK_3:\r\n\r\n* Dbg coupling -2.20013 -4.69832 1.06076 -0.003349 0.069256 1.57054\r\n* Dbg spout -2.5 -3.5 1.2 -1.5707 -0 -0\r\n* Dbg connectPose 1.2e-05 -0.125623 0.35 -0.041215 -1.57078 1.61199\r\n* Dbg relativePose 0.299871 0.139127 -1.19833 0.000399 -1.50144 1.56706\r\n* Dbg connect offset -1.54832 -0.299852 -0.264782 -0.003327 0.069336 -0.000259\r\n* Dbg xyz 1.59917\r\n* Dbg rpy 0.0694017\r\n* Dbg valve -1.21592e-12\r\n* Dbg relPose.Zaxis -0.003331 -0.99759 0.069297\r\n* Dbg connPose.Zaxis -2.2e-05 -1 1.6e-05\r\n* Dbg coupling.Zaxis -0.003331 0.069201 0.997597\r\n* Dbg spout.Zaxis 0 1 9.6e-05\r\n* Dbg rotErr_cga 1.36433\r\n\r\nAt the start the hose points away from the spigot, so having a small rotErr\r\nis bad (0.0694017). The rotErr should be maximal.\r\n\r\nThe main issue is that the \"Z axis\" of the hose points upward along the Z axis.\r\nIt should point horizontally along the long axis of the coupling, as the hose is horizontal at the start of the task. I see that coupling_relative_pose in the world file\r\ncompensates for this. I don't think it is correct. It means the robot needs to very carefully never rotate the coupling about its long axis during the connection. This conflicts with screwing the coupling by rotating it around its long axis.\r\nIt also means that any orientation of the coupling with that \"Z axis\" aligned with\r\nthe z axis is okay (including pointing away from the spout, or being perpendicular to it.\r\n\r\nI believe this is what is preventing attachment when it appears the hose is correctly aligned.\r\n\r\nI think the hose coupling should be redefined so it's Z axis is along its long axis.\r\n\r\nHere are some printouts with the coupling in what we believe is roughly the right place and alignment.\r\nNote that coupling.Zaxis is very different in the two runs.\r\n\r\n* coupling -3.18106 -4.10214 1.36715 0.621199 0.009171 -1.56043\r\n* spout -3.18 -4.09 1.37 -1.5707 0 -0\r\n* connectPose 1.2e-05 0 0 2.97 1.48 -0.275\r\n* relativePose -0.001061 0.002849 -0.01214 2.91118 1.55702 0.719231\r\n* connect offset 0.011926 -0.00291 0.002439 -1.0515 -0.080077 -0.025667\r\n* xyz 0.0125155\r\n* rpy 1.00531\r\n* valve -1.2168e-12\r\n* relPose.Zaxis -0.581902 -0.813148 -0.013411\r\n* connPose.Zaxis -0.990752 0.102121 -0.08934\r\n* coupling.Zaxis -0.581902 -0.013489 0.813147\r\n* spout.Zaxis 0 1 9.6e-05\r\n* rotErr_cga 1.42366\r\n\r\nand\r\n\r\n* coupling -3.1951 -4.10624 1.37255 1.74921 0.016014 -1.37723\r\n* spout -3.18 -4.09 1.37 -1.5707 -0 -0\r\n* connectPose 1.2e-05 0 0 2.97 1.48 1.075\r\n* relativePose -0.015105 -0.002557 -0.016241 -2.88217 1.37658 0.082577\r\n* connect offset 0.015318 -0.01376 0.008652 1.41509 -0.01173 0.162707\r\n* xyz 0.0223347\r\n* rpy 1.29995\r\n* valve -1.2168e-12\r\n* relPose.Zaxis -0.966294 0.177429 -0.186535\r\n* connPose.Zaxis -0.316623 -0.944335 -0.08934\r\n* coupling.Zaxis -0.966294 -0.186518 -0.177447\r\n* spout.Zaxis 0 1 9.6e-05\r\n* rotErr_cga 1.54048\r\n\r\nHere is the relevant code. I thought rotErr_cga would be the right answer, but it is not given the definition of the axes. Probably the X or Y axis for the coupling link would have worked.\r\n\r\n\r\n```\r\n#!c++\r\n  double rotErr_cga\r\n    = (this->drcFireHose.couplingLink->GetWorldPose().rot.GetZAxis() -\r\n       this->drcFireHose.spoutLink->GetWorldPose().rot.GetZAxis()).GetLength();\r\n\r\n      gzdbg << \"\\ncoupling \" << this->drcFireHose.couplingLink->GetWorldPose() \\\r\n<< \"\\n\";\r\n      gzdbg << \"spout \" << this->drcFireHose.spoutLink->GetWorldPose() << \"\\n\";\r\n      gzdbg << \"connectPose \" << connectPose << \"\\n\";\r\n      gzdbg << \"relativePose \" << relativePose << \"\\n\";\r\n      gzdbg << \"connect offset \" << connectOffset << \"\\n\";\r\n      gzdbg << \"xyz \" << posErr << \"\\n\";\r\n      gzdbg << \"rpy \" << rotErr << \"\\n\";\r\n      gzdbg << \"valve \" << valveAng << \"\\n\";\r\n      gzdbg << \"relPose.Zaxis \" << relativePose.rot.GetZAxis() << \"\\n\";\r\n      gzdbg << \"connPose.Zaxis \" << connectPose.rot.GetZAxis() << \"\\n\";\r\n      gzdbg << \"coupling.Zaxis \" << this->drcFireHose.couplingLink->GetWorldPos\\\r\ne().rot.GetZAxis() << \"\\n\";\r\n      gzdbg << \"spout.Zaxis \" << this->drcFireHose.spoutLink->GetWorldPose().ro\\\r\nt.GetZAxis() << \"\\n\";\r\n      gzdbg << \"rotErr_cga \" << rotErr_cga << \"\\n\";\r\n\r\n\r\n```\r\n", "markup": "markdown", "html": "<p>I believe the rotation error calculation in the firehose alignment does not currently make sense. I printed out a bunch of stuff at the beginning of VRC_TASK_3:</p>\n<ul>\n<li>Dbg coupling -2.20013 -4.69832 1.06076 -0.003349 0.069256 1.57054</li>\n<li>Dbg spout -2.5 -3.5 1.2 -1.5707 -0 -0</li>\n<li>Dbg connectPose 1.2e-05 -0.125623 0.35 -0.041215 -1.57078 1.61199</li>\n<li>Dbg relativePose 0.299871 0.139127 -1.19833 0.000399 -1.50144 1.56706</li>\n<li>Dbg connect offset -1.54832 -0.299852 -0.264782 -0.003327 0.069336 -0.000259</li>\n<li>Dbg xyz 1.59917</li>\n<li>Dbg rpy 0.<a href=\"#!/osrf/drcsim/commits/0694017\" rel=\"nofollow\" class=\"ap-connect-link\">0694017</a></li>\n<li>Dbg valve -1.21592e-12</li>\n<li>Dbg relPose.Zaxis -0.003331 -0.99759 0.069297</li>\n<li>Dbg connPose.Zaxis -2.2e-05 -1 1.6e-05</li>\n<li>Dbg coupling.Zaxis -0.003331 0.069201 0.997597</li>\n<li>Dbg spout.Zaxis 0 1 9.6e-05</li>\n<li>Dbg rotErr_cga 1.36433</li>\n</ul>\n<p>At the start the hose points away from the spigot, so having a small rotErr\nis bad (0.<a href=\"#!/osrf/drcsim/commits/0694017\" rel=\"nofollow\" class=\"ap-connect-link\">0694017</a>). The rotErr should be maximal.</p>\n<p>The main issue is that the \"Z axis\" of the hose points upward along the Z axis.\nIt should point horizontally along the long axis of the coupling, as the hose is horizontal at the start of the task. I see that coupling_relative_pose in the world file\ncompensates for this. I don't think it is correct. It means the robot needs to very carefully never rotate the coupling about its long axis during the connection. This conflicts with screwing the coupling by rotating it around its long axis.\nIt also means that any orientation of the coupling with that \"Z axis\" aligned with\nthe z axis is okay (including pointing away from the spout, or being perpendicular to it.</p>\n<p>I believe this is what is preventing attachment when it appears the hose is correctly aligned.</p>\n<p>I think the hose coupling should be redefined so it's Z axis is along its long axis.</p>\n<p>Here are some printouts with the coupling in what we believe is roughly the right place and alignment.\nNote that coupling.Zaxis is very different in the two runs.</p>\n<ul>\n<li>coupling -3.18106 -4.10214 1.36715 0.621199 0.009171 -1.56043</li>\n<li>spout -3.18 -4.09 1.37 -1.5707 0 -0</li>\n<li>connectPose 1.2e-05 0 0 2.97 1.48 -0.275</li>\n<li>relativePose -0.001061 0.002849 -0.01214 2.91118 1.55702 0.719231</li>\n<li>connect offset 0.011926 -0.00291 0.002439 -1.0515 -0.080077 -0.025667</li>\n<li>xyz 0.<a href=\"#!/osrf/drcsim/commits/0125155\" rel=\"nofollow\" class=\"ap-connect-link\">0125155</a></li>\n<li>rpy 1.00531</li>\n<li>valve -1.2168e-12</li>\n<li>relPose.Zaxis -0.581902 -0.813148 -0.013411</li>\n<li>connPose.Zaxis -0.990752 0.102121 -0.08934</li>\n<li>coupling.Zaxis -0.581902 -0.013489 0.813147</li>\n<li>spout.Zaxis 0 1 9.6e-05</li>\n<li>rotErr_cga 1.42366</li>\n</ul>\n<p>and</p>\n<ul>\n<li>coupling -3.1951 -4.10624 1.37255 1.74921 0.016014 -1.37723</li>\n<li>spout -3.18 -4.09 1.37 -1.5707 -0 -0</li>\n<li>connectPose 1.2e-05 0 0 2.97 1.48 1.075</li>\n<li>relativePose -0.015105 -0.002557 -0.016241 -2.88217 1.37658 0.082577</li>\n<li>connect offset 0.015318 -0.01376 0.008652 1.41509 -0.01173 0.162707</li>\n<li>xyz 0.<a href=\"#!/osrf/drcsim/commits/0223347\" rel=\"nofollow\" class=\"ap-connect-link\">0223347</a></li>\n<li>rpy 1.29995</li>\n<li>valve -1.2168e-12</li>\n<li>relPose.Zaxis -0.966294 0.177429 -0.186535</li>\n<li>connPose.Zaxis -0.316623 -0.944335 -0.08934</li>\n<li>coupling.Zaxis -0.966294 -0.186518 -0.177447</li>\n<li>spout.Zaxis 0 1 9.6e-05</li>\n<li>rotErr_cga 1.54048</li>\n</ul>\n<p>Here is the relevant code. I thought rotErr_cga would be the right answer, but it is not given the definition of the axes. Probably the X or Y axis for the coupling link would have worked.</p>\n<div class=\"codehilite language-c++\"><pre><span></span>  <span class=\"kt\">double</span> <span class=\"n\">rotErr_cga</span>\n    <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"k\">this</span><span class=\"o\">-&gt;</span><span class=\"n\">drcFireHose</span><span class=\"p\">.</span><span class=\"n\">couplingLink</span><span class=\"o\">-&gt;</span><span class=\"n\">GetWorldPose</span><span class=\"p\">().</span><span class=\"n\">rot</span><span class=\"p\">.</span><span class=\"n\">GetZAxis</span><span class=\"p\">()</span> <span class=\"o\">-</span>\n       <span class=\"k\">this</span><span class=\"o\">-&gt;</span><span class=\"n\">drcFireHose</span><span class=\"p\">.</span><span class=\"n\">spoutLink</span><span class=\"o\">-&gt;</span><span class=\"n\">GetWorldPose</span><span class=\"p\">().</span><span class=\"n\">rot</span><span class=\"p\">.</span><span class=\"n\">GetZAxis</span><span class=\"p\">()).</span><span class=\"n\">GetLength</span><span class=\"p\">();</span>\n\n      <span class=\"n\">gzdbg</span> <span class=\"o\">&lt;&lt;</span> <span class=\"s\">&quot;</span><span class=\"se\">\\n</span><span class=\"s\">coupling &quot;</span> <span class=\"o\">&lt;&lt;</span> <span class=\"k\">this</span><span class=\"o\">-&gt;</span><span class=\"n\">drcFireHose</span><span class=\"p\">.</span><span class=\"n\">couplingLink</span><span class=\"o\">-&gt;</span><span class=\"n\">GetWorldPose</span><span class=\"p\">()</span> \\\n<span class=\"o\">&lt;&lt;</span> <span class=\"s\">&quot;</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">;</span>\n      <span class=\"n\">gzdbg</span> <span class=\"o\">&lt;&lt;</span> <span class=\"s\">&quot;spout &quot;</span> <span class=\"o\">&lt;&lt;</span> <span class=\"k\">this</span><span class=\"o\">-&gt;</span><span class=\"n\">drcFireHose</span><span class=\"p\">.</span><span class=\"n\">spoutLink</span><span class=\"o\">-&gt;</span><span class=\"n\">GetWorldPose</span><span class=\"p\">()</span> <span class=\"o\">&lt;&lt;</span> <span class=\"s\">&quot;</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">;</span>\n      <span class=\"n\">gzdbg</span> <span class=\"o\">&lt;&lt;</span> <span class=\"s\">&quot;connectPose &quot;</span> <span class=\"o\">&lt;&lt;</span> <span class=\"n\">connectPose</span> <span class=\"o\">&lt;&lt;</span> <span class=\"s\">&quot;</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">;</span>\n      <span class=\"n\">gzdbg</span> <span class=\"o\">&lt;&lt;</span> <span class=\"s\">&quot;relativePose &quot;</span> <span class=\"o\">&lt;&lt;</span> <span class=\"n\">relativePose</span> <span class=\"o\">&lt;&lt;</span> <span class=\"s\">&quot;</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">;</span>\n      <span class=\"n\">gzdbg</span> <span class=\"o\">&lt;&lt;</span> <span class=\"s\">&quot;connect offset &quot;</span> <span class=\"o\">&lt;&lt;</span> <span class=\"n\">connectOffset</span> <span class=\"o\">&lt;&lt;</span> <span class=\"s\">&quot;</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">;</span>\n      <span class=\"n\">gzdbg</span> <span class=\"o\">&lt;&lt;</span> <span class=\"s\">&quot;xyz &quot;</span> <span class=\"o\">&lt;&lt;</span> <span class=\"n\">posErr</span> <span class=\"o\">&lt;&lt;</span> <span class=\"s\">&quot;</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">;</span>\n      <span class=\"n\">gzdbg</span> <span class=\"o\">&lt;&lt;</span> <span class=\"s\">&quot;rpy &quot;</span> <span class=\"o\">&lt;&lt;</span> <span class=\"n\">rotErr</span> <span class=\"o\">&lt;&lt;</span> <span class=\"s\">&quot;</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">;</span>\n      <span class=\"n\">gzdbg</span> <span class=\"o\">&lt;&lt;</span> <span class=\"s\">&quot;valve &quot;</span> <span class=\"o\">&lt;&lt;</span> <span class=\"n\">valveAng</span> <span class=\"o\">&lt;&lt;</span> <span class=\"s\">&quot;</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">;</span>\n      <span class=\"n\">gzdbg</span> <span class=\"o\">&lt;&lt;</span> <span class=\"s\">&quot;relPose.Zaxis &quot;</span> <span class=\"o\">&lt;&lt;</span> <span class=\"n\">relativePose</span><span class=\"p\">.</span><span class=\"n\">rot</span><span class=\"p\">.</span><span class=\"n\">GetZAxis</span><span class=\"p\">()</span> <span class=\"o\">&lt;&lt;</span> <span class=\"s\">&quot;</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">;</span>\n      <span class=\"n\">gzdbg</span> <span class=\"o\">&lt;&lt;</span> <span class=\"s\">&quot;connPose.Zaxis &quot;</span> <span class=\"o\">&lt;&lt;</span> <span class=\"n\">connectPose</span><span class=\"p\">.</span><span class=\"n\">rot</span><span class=\"p\">.</span><span class=\"n\">GetZAxis</span><span class=\"p\">()</span> <span class=\"o\">&lt;&lt;</span> <span class=\"s\">&quot;</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">;</span>\n      <span class=\"n\">gzdbg</span> <span class=\"o\">&lt;&lt;</span> <span class=\"s\">&quot;coupling.Zaxis &quot;</span> <span class=\"o\">&lt;&lt;</span> <span class=\"k\">this</span><span class=\"o\">-&gt;</span><span class=\"n\">drcFireHose</span><span class=\"p\">.</span><span class=\"n\">couplingLink</span><span class=\"o\">-&gt;</span><span class=\"n\">GetWorldPos</span>\\\n<span class=\"n\">e</span><span class=\"p\">().</span><span class=\"n\">rot</span><span class=\"p\">.</span><span class=\"n\">GetZAxis</span><span class=\"p\">()</span> <span class=\"o\">&lt;&lt;</span> <span class=\"s\">&quot;</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">;</span>\n      <span class=\"n\">gzdbg</span> <span class=\"o\">&lt;&lt;</span> <span class=\"s\">&quot;spout.Zaxis &quot;</span> <span class=\"o\">&lt;&lt;</span> <span class=\"k\">this</span><span class=\"o\">-&gt;</span><span class=\"n\">drcFireHose</span><span class=\"p\">.</span><span class=\"n\">spoutLink</span><span class=\"o\">-&gt;</span><span class=\"n\">GetWorldPose</span><span class=\"p\">().</span><span class=\"n\">ro</span>\\\n<span class=\"n\">t</span><span class=\"p\">.</span><span class=\"n\">GetZAxis</span><span class=\"p\">()</span> <span class=\"o\">&lt;&lt;</span> <span class=\"s\">&quot;</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">;</span>\n      <span class=\"n\">gzdbg</span> <span class=\"o\">&lt;&lt;</span> <span class=\"s\">&quot;rotErr_cga &quot;</span> <span class=\"o\">&lt;&lt;</span> <span class=\"n\">rotErr_cga</span> <span class=\"o\">&lt;&lt;</span> <span class=\"s\">&quot;</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">;</span>\n</pre></div>", "type": "rendered"}, "assignee": null, "state": "resolved", "version": null, "edited_on": null, "created_on": "2013-05-17T01:45:32.781801+00:00", "milestone": null, "updated_on": "2013-05-18T02:08:01.947715+00:00", "type": "issue", "id": 282}